/dts-v1/;
/plugin/;

#include <dt-bindings/clock/rk3588-cru.h>
#include <dt-bindings/power/rk3588-power.h>
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/pinctrl/rockchip.h>

/ {
    metadata {
        title ="Enable HDMI MIPI Capture Card";
        compatible = "radxa,rock-5a", "radxa,rock-5c";
        category = "capture-card";
        exclusive = "csi2_dphy0";
        description = "Enable Firefly RK628d HDMI to MIPI Capture Card.";
    };
};

&i2c3 {
    status = "okay";
    #address-cells = <1>;
    #size-cells = <0>;

    rk628_csi_v4l2: rk628_csi_v4l2@50 {
        reg = <0x50>;
        compatible = "rockchip,rk628-csi-v4l2";
        interrupt-parent = <&gpio1>;
        interrupts = <RK_PD6 IRQ_TYPE_LEVEL_HIGH>;
        enable-gpios = <&gpio1 RK_PA7 GPIO_ACTIVE_LOW>;
        reset-gpios = <&gpio1 RK_PB0 GPIO_ACTIVE_LOW>;
        plugin-det-gpios = <&gpio1 RK_PB2 GPIO_ACTIVE_LOW>;
        rockchip,camera-module-index = <1>;
        rockchip,camera-module-facing = "back";
        rockchip,camera-module-name = "RK628D-HDMI-MIPI-Capture";
        rockchip,camera-module-lens-name = "NC";
        port {
            hdmiin_out0: endpoint {
                remote-endpoint = <&mipidphy0_in_ucam1>;
                data-lanes = <1 2 3 4>;
            };
        };
    };
};

// &csi2_dphy0_hw {
// 	status = "okay";
// };

&csi2_dphy0 {
    status = "okay";

    ports {
        #address-cells = <1>;
        #size-cells = <0>;

        port@0 {
            reg = <0>;
            #address-cells = <1>;
            #size-cells = <0>;

            mipidphy0_in_ucam1: endpoint@2 {
                reg = <2>;
                remote-endpoint = <&hdmiin_out0>;
                data-lanes = <1 2 3 4>;
            };
        };

        port@1 {
            reg = <1>;
            #address-cells = <1>;
            #size-cells = <0>;

            csidphy0_out: endpoint@0 {
                reg = <0>;
                remote-endpoint = <&mipi2_csi2_input0>;
            };
        };
    };
};

&mipi2_csi2 {
    status = "okay";

    ports {
        #address-cells = <1>;
        #size-cells = <0>;

        port@0 {
            reg = <0>;
            #address-cells = <1>;
            #size-cells = <0>;

            mipi2_csi2_input0: endpoint@0 {
                reg = <0>;
                remote-endpoint = <&csidphy0_out>;
            };
        };

        port@1 {
            reg = <1>;
            #address-cells = <1>;
            #size-cells = <0>;

            mipi2_csi2_output: endpoint@0 {
                reg = <0>;
                remote-endpoint = <&cif_mipi2_in0>;
            };
        };
    };
};

&rkcif {
    status = "okay";
};

&rkcif_mipi_lvds2 {
    status = "okay";

    port {
        cif_mipi2_in0: endpoint {
            remote-endpoint = <&mipi2_csi2_output>;
        };
    };
};

// &rkcif_mipi_lvds2_sditf {
// 	status = "okay";

// 	port {
// 		mipi_lvds2_sditf: endpoint {
// 			remote-endpoint = <&isp0_vir0>;
// 		};
// 	};
// };

&rkcif_mmu {
    status = "okay";
};

&isp0_mmu {
    status = "okay";
};

&rkisp0 {
    status = "okay";
};

&rkisp0_vir0 {
    status = "okay";

    port {
        #address-cells = <1>;
        #size-cells = <0>;

        isp0_vir0: endpoint@0 {
            reg = <0>;
            remote-endpoint = <&mipi_lvds2_sditf>;
        };
    };
};

&pinctrl {
    cam {
        // Power control for the MIPI DPHY
        mipidphy0_pwr: mipidphy0-pwr {
            rockchip,pins =
                <1 RK_PB1 RK_FUNC_GPIO &pcfg_pull_none>; // Power for MIPI PHY
        };
    };
};